\chapter{Metodologia}
\label{chap:metodologia}
\thispagestyle{empty}

É apresentado neste capítulo o desenvolvimento realizado neste projeto, os problemas encontrados e as soluções propostas.
Na primeira e segunda seção tem-se a definição do modelo matemático do veículo protótipo DT1 e da pista. A terceira seção traz a formulação proposta para o problema de controle ótimo que encontrar
a estratégia de pista ótima. Por fim, na última  seção é apresentado os passos realizados no desenvolvimento do código que soluciona o OCP proposto. 

\section{Modelo do veículo DT1} 

O modelo da dinâmica do veículo protótipo DT1 foi definido com base na revisão bibliográfica apresentada na Seção \ref{sec:modelo}. 
Para isto as seguintes simplificações e considerações foram feita:

\begin{itemize}
    \item \textbf{Dinâmica lateral:} não foi levando em conta a dinâmica lateral do veículo considerando que ele se move apenas em linha reta; 
    \item \textbf{Vento:} a velocidade do vento foi desconsiderada na Equação (\ref{eq:Fa});
    \item \textbf{Pneus:} a variação do coeficiente de rolamento em função da temperatura, da pressão e a velocidade não foi considerada na Equação (\ref{eq:Fr});
    \item \textbf{Rolamentos:} o atrito viscos dos rolamentos foi considerado nulo;
    \item \textbf{Perdas elétricas:} a bateria e o conversor eletrônico de potência foram tratados como componentes ideias não modificações na dinâmica das grandezas elétricas;
    \item \textbf{Indutância do motor:} como a dinâmica da velocidade é pelo menos dez vez mais lenta que a dinâmica da corrente elétrica, a contribuição do  indutor foi removida da Equação (\ref{eq:propulsao_1}).  
\end{itemize}

A partir das Equações (\ref{eq:SomaForcas}) à (\ref{eq:Fr}) e (\ref{eq:propulsao}) e destas simplificações e considerações foi definido a 
seguinte equação para descrever o comportamento do veículo

\begin{subequations}
	\label{eq:modelo_1}
    \begin{align}
        \left( m_v + m_p + N_r \cdot \frac{J_r}{r_r^2}  + \frac{J_m}{r_m^2} \right) \dot v = F_t - (F_a + F_g + F_r) \enspace,\\   
        F_{t} =  \frac{K_t \cdot i_a \cdot \eta}{r_m} \enspace,\\
		R_{a} \cdot i_{a} = u - \frac{K_{v} \cdot v}{r_m} \enspace, \\
        F_{a} = \frac{\rho \cdot a_f \cdot c_d \cdot v^2}{2} \enspace,\\
        F_{g} = (m_v + m_p) \cdot g \cdot \sin(\theta(x)) \enspace,\\
        F_{r}  = c_{r} \cdot (m_v + m_p) \cdot g \cdot \cos(\theta(x)) \enspace,
	\end{align}
\end{subequations}

em que as variáveis são $\dot v$ a aceleração 
do carro em [$m/s^2$], $v$ a velocidade do carro em [$m/s^2$], $x$ a distância  percorrida pelo carro na pista em [$m$], 
$u$ a tensão aplicada no motor em [$V$], $r_m$ o raio do cilindro de transmissão no eixo do motor elétrico em [$m$] e $\theta$ é a inclinação da pista em [$rad$] 
e as constantes estão apresentadas na Tabela \ref{tab:constantes}. Não foi realizado ensaio para determinar ou verificar essas constantes e este modelo
pois o projeto foi realizado, em sua maior parte, durante o Ensino Remoto Emergencial de 2020. As constantes foram definidas através da bibliografia apresentada
e por dados fornecidos pela equipe Milhagem UFMG. 

% em que as variáveis são $u$ a tensão aplicada no motor em [$V$], 
% $r_m$ o raio do cilindro de transmissão no eixo do motor em [$m$], 
% $\theta$ é a inclinação da pista em [$rad$], $\dot v$, $v$ e $x$ são respectivamente a aceleração em [$m/s^2$], a velocidade em [$m/s$] e posição [$m$] do carro
% e as constantes estão apresentadas na Tabela \ref{tab:constantes}. Não foi realizado ensaio para determinar ou verificar essas constantes ou este modelo
% pois o projeto foi realizado, em sua maior parte, durante o Ensino Remoto Emergêncial. As constantes foram definidas através da bibliografia apresentada
% e por dados fornecidos pela equipe Milhagem UFMG. 

\begin{table}[H]
	\centering
	\caption{Constantes utilizadas no modelo do veículo}
	\rowcolors{1}{}{lightgray}
	\begin{tabular}{llll}
		\toprule
		\textbf{Constante} & \textbf{Simbolo} & \textbf{Unidade} & \textbf{Valor}\\
		\hline
		Massa veículo                       & $m_v$  & [$kg$]              & 36      \\
        Massa do piloto                     & $m_p$  & [$kg$]              & 50      \\
        Resistência de armadura             & $R_a$  & [$\Omega$]        & 0,07    \\  
        Const. de tensão induzida           & $K_v$  & [$V/(rad/s)$]       & 0,119   \\
        Quantidade de rodas                 & $N_r$  & [ ]                & 3       \\
        Momento de inercia da roda          & $J_r$  & [$kg.m^2$]        & 0,015   \\
        Momento de inercia do motor         & $J_m$  & [$kg.m^2$]        & $0,0625 \times 10^{-3}$\\
        Raio da roda                        & $r_r$  & [$m$]               & 0,254   \\
        Const. de torque                    & $K_t$  & [$Nm/A$]            & 0,119   \\
        Eficiência da roda de atrito        & $\eta$ & [ ]                & 0,95    \\
        Densidade do ar                     & $\rho$ & [$kg/m^3$]        & 1,22    \\
        Areá fronta do veículo              & $a_f$  & [$m^2$]           & 0,26    \\
        Coef. de arrasto aerodinâmico       & $c_d$  & [ ]                & 0,164   \\
        Aceleração da gravidade             & $g$    & [$m/s^2$]         & 9,81    \\
        Coef. de resistência ao rolamento   & $c_r$  & [ ]                & 0,0024  \\
		\bottomrule
	\end{tabular}
	\caption*{\footnotesize Fonte: Elaborada pelo autor.}
	\label{tab:constantes}
\end{table}


\section{Modelo da pista}

Para obter os dados de altitude da pista da Shell Eco-marathon Americas de 2019 no Kartódromo de Sonoma foi feito uma requisição a equipe
\textit{Duke Electric Vehicles} da \textit{Duke University} que disponibilizou os dados coletados e tratos por ela. A Figura apresentada \ref{fig:altitude_pista} 
o perfil de altitude da pista com estes dados.

\begin{figure}[h]
    \centering
    \caption{Perfil de altitude da pista da Shell Eco-marathon Americas de 2019}
    \input{Metodologia/Figuras/altitude_pista.tex}
    \label{fig:altitude_pista}
    \caption*{\footnotesize{Fonte: Dados da equipe de competição \textit{Duke Electric Vehicles}.}}
\end{figure}

Uma forma de representar esses dados no código para solução o OCP é por meio de uma \textit{lookup table} porem ao implementar os dados dessa foram
a solução não convergiu. Uma possível explicação para essa não convergência é que os dados eram derivados duas vezes, uma para determinar a inclinação e outra pelo 
realizada algorítimo de otimização e ao analisar esses dados derivados usando o comando \lstinline[style=Matlab-editor]{diff} do MATLAB  foram observadas curvas
com grande variação de inclinação e ruido. Alem disso seria preciso repetir sete vezes os dois vetores de dados para emular as repetidas voltas realiza pelo carro durante a tentativa.
A solução para esses problemas foi aproximar a curva de altitude da pista por uma sona de senos com o comando \lstinline[style=Matlab-editor]{fit(x, h, 'sin8')} do MATLAB  
e então realizar a derivada para obter a seguinte equação inclinação:

\begin{equation}
	\label{eq:modeloTheta}
	\theta(x) = arctg \left( \sum_{n = 1}^{8} + a_n \cdot cos(b_n \cdot x + c_n) \right)
	\enspace,
\end{equation}

% \begin{table}[H]
% 	\centering
% 	\caption{Ceficientes da Equação (\ref{eq:modeloTheta})}
% 	\rowcolors{1}{}{lightgray}
% 	\begin{tabular}{crcr}
% 		\toprule
% 		\textbf{Coef.} & \textbf{Valor} & \textbf{Coef.} & \textbf{Valor}\\
% 		\hline
% 		$a_1$   & 0,012293 & $a_5$   & 0,003958  \\
%         $b_1$   & 0,004363 & $b_5$   & 0,017449  \\
%         $c_1$   &-0,228758 & $c_5$   &-3,058604  \\  
%         $a_2$   & 0,003041 & $a_6$   & 0,005365  \\
%         $b_2$   & 0,000236 & $b_6$   & 0,026184  \\
%         $c_2$   & 0,399758 & $c_6$   & 0,579933  \\
%         $a_3$   & 0,005818 & $a_7$   & 0,004361  \\
%         $b_3$   & 0,008726 & $b_7$   & 0,021814  \\
%         $c_3$   &-2,193381 & $c_7$   & 1,627015  \\
%         $a_4$   & 0,002926 & $a_8$   & 0,005539  \\
%         $b_4$   & 0,000246 & $b_8$   & 0,030552  \\
%         $c_4$   & 3,490690 & $c_8$   &-1,400496  \\
% 		\bottomrule
% 	\end{tabular}
% 	\caption*{\footnotesize Fonte: Elaborada pelo autor.}
% 	\label{tab:coeficientes}
% \end{table}

\begin{table}[H]
	\centering
	\caption{Coeficientes da Equação (\ref{eq:modeloTheta})}
	\rowcolors{1}{}{lightgray}
	\begin{tabular}{crcrcrcr}
		\toprule
		\textbf{Coef.} & \textbf{Valor} & \textbf{Coef.} & \textbf{Valor} & \textbf{Coef.} & \textbf{Valor} & \textbf{Coef.} & \textbf{Valor}\\
		\hline
        $a_1$   & 0,012293 & $a_3$   & 0,005818 & $a_5$   & 0,003958 & $a_7$   & 0,004361  \\
        $b_1$   & 0,004363 & $b_3$   & 0,008726 & $b_5$   & 0,017449 & $b_7$   & 0,021814  \\
        $c_1$   &-0,228758 & $c_3$   &-2,193381 & $c_5$   &-3,058604 & $c_7$   & 1,627015  \\
        $a_2$   & 0,003041 & $a_4$   & 0,002926 & $a_6$   & 0,005365 & $a_8$   & 0,005539  \\
        $b_2$   & 0,000236 & $b_4$   & 0,000246 & $b_6$   & 0,026184 & $b_8$   & 0,030552  \\
        $c_2$   & 0,399758 & $c_4$   & 3,490690 & $c_6$   & 0,579933 & $c_8$   &-1,400496  \\
		\bottomrule
	\end{tabular}
	\caption*{\footnotesize Fonte: Elaborada pelo autor.}
	\label{tab:coeficientes}
\end{table}


\section{Problema de controle ótimo (OCP)}
\label{sec:OCPporposto}

Utilizando a formulação genérica de OCP da Equação (\ref{eq:formulacaoOCP}), o modelo do veículo dado pela Equação (\ref{eq:modelo_1})
e o manual de regras de competição da Shell EcoMarathon Américas de 2019 
foi definida a seguinte formulação para o problema de controle ótimo de encontrar a estratégia de pista que minimiza o consumo de energia

\begin{mini!}
	{i(t), r_m, T}{\int_{0}^{T} i(t) \cdot [i(t) \cdot Ra + Kv \cdot (v(t)/r_m)] \,\mathrm{d}t \label{eq:ObjOCP_final}}
	{\label{eq:formulacaoOCP_final}}{}
    \addConstraint{x(0)}{=0 \label{eq:C1_OCP_final}}{}
    \addConstraint{v(0)}{=0 \label{eq:C2_OCP_final}}{}
    \addConstraint{\dot x(t) - v(t)}{=0, \quad}{t \in \left[0,T\right]  \label{eq:C3_OCP_final}}
    \addConstraint{\dot v(t) - \frac{F_t - (F_a + F_g + F_r)}{M}}{=0, \quad}{t \in \left[0,T\right]  \label{eq:C4_OCP_final}}
	\addConstraint{i(t)-\frac{42-Kv\cdot(v/r_m)}{R_a}}{\leq 0, \quad}{t \in \left[0,T\right]  \label{eq:C5_OCP_final}}
    \addConstraint{0 \leq i(t)}{\leq 30, \quad}{t \in \left[0,T\right]  \label{eq:C6_OCP_final}}
    \addConstraint{0 \leq v(t)}{\leq 12.5, \quad}{t \in \left[0,T\right]  \label{eq:C7_OCP_final}}
    \addConstraint{x(T)}{= 10080 \label{eq:C8_OCP_final}}{}
	\addConstraint{T}{\leq 1400 \label{eq:C9_OCP_final}}{}
	\addConstraint{0.020\leq r_m}{ \leq 0.050, \label{eq:C10_OCP_final}}{}
\end{mini!}

em que a Equação (\ref{eq:ObjOCP_final}) define a energia elétrica consumida como custo a ser minimizado, 
as Equações (\ref{eq:C1_OCP_final}) e (\ref{eq:C2_OCP_final}) são restrições para os estados iniciaisde distância  percorrida e velocidade nulos, 
as Equações (\ref{eq:C3_OCP_final}) e (\ref{eq:C4_OCP_final}) são as restrições que garantem que os estados da reposta repeitem a dinâmica do modelo da Equação (\ref{eq:modelo_1}), 
a Equação (\ref{eq:C5_OCP_final}) é uma restrição de caminho para corrente em razão da tensão máxima da bateria, 
a Equação (\ref{eq:C6_OCP_final}) é uma restrição para o valor máximo de corrente em função do limite de corrente entregue pelo conversor de potência do veículo,
a Equação (\ref{eq:C7_OCP_final}) é uma restrição para o valor máximo da velocidade do carro definida pela organização da competição,
a Equação (\ref{eq:C8_OCP_final}) é um restrições de valor final fixo para a distância  percorrida equivalente a sete voltas na pista,
a Equação (\ref{eq:C9_OCP_final}) é uma restrição para o valor máximo do tempo final em decorrência do limite de velocidade media mínima determinado pela organização da competição,
e a Equação (\ref{eq:C10_OCP_final}) é o intervalo possível para o raio do eixo do motor.


\begin{table}[H]
	\centering
	\caption{Constantes utilizadas no OCP}
	\rowcolors{1}{}{lightgray}
	\begin{tabular}{llll}
		\toprule
		\textbf{Constante} & \textbf{Simbolo} & \textbf{Unidade} & \textbf{Valor}\\
		\hline
		Tensão da bateria   & $u_{bat}$     & [$V$]    & 42    \\
        Corrente máxima     & $I_{max}$     & [$A$]    & 30    \\
        Velocidade máxima   & $v_{max}$     & [$m/s$]  & 12,5  \\  
        Distância total     & $x_f$         & [$m$]    & 10080 \\
        Tempo final         & $t_f$         & [$s$]    & 1400  \\
        Raio minimo         & $r_{m,min}$   & [$m$]    & 0,02  \\
        Raio máxima         & $r_{m,max}$   & [$m$]    & 0,05  \\
		\bottomrule
	\end{tabular}
	\caption*{\footnotesize Fonte: Elaborada pelo autor.}
	\label{tab:constantes_OCP}
\end{table}

\section{Código para solução do OCP}
\label{sec:metodologia_codigos}

Nesta etapa do trabalho a versão do MATLAB  utilizada foi a R2019b Update 7 e a versão do FALCON.m utilizada foi a v1.26.
O compilador MinGW-w64 C/C++, pré-requisito da biblioteca FALCON, foi instalado gratuitamente na versão 19.2.0 pela loja de aplicativos do MATLAB . 
A licença do MATLAB  utilizada foi a licença acadêmica fornecida pela UFMG à seus alunos. Já a licença do FALCON.m, de uso individual e intransferível,
foi obtida por meio de solicitação feita ao \textit{Institute of Flight System Dynamics} da \textit{Technische Universit{\"a}t M{\"u}nchen} pelo site \url{https://www.fsd.lrg.tum.de/software/falcon-m/license-and-download/}.

A implementação do código para solução do problema de controle ótimo proposto segui os seguintes passos:

\begin{enumerate}
    \item \textbf{Definir as variáveis de estado e de controle e os parâmetros:} no arquivo principal, do tipo \textit{script}, instanciar as  as variáveis de estado e de controle e os parâmetros otimizáveis e seus limites máximos e mínimos;
    \item \textbf{Implementar os modelos dinâmicos:} em arquivos do tipo \textit{function}, implementar o modelo dinâmico do sistema; 
    \item \textbf{Definir os modelos dinâmicos dos subsistemas:} no arquivo principal, utilizar o e \textit{Model Builder} da \textit{FALCON.m} para vincular os arquivos do passo 2 no programa principal;
    \item \textbf{Derivar as funções necessária:} o \textit{Model Builder} irá criar, a partir da chamado do método \lstinline[style=Matlab-editor]{.Build()}, as derivadas analíticas de todos os subsistemas e combiná-los ao gradiente geral dos modelos usando a regra da cadeia;
    \item \textbf{Implementar funções de custo e de restrição de caminho:} repetir os passos de 1 à 4 para todas as restrições de caminho e funções de custo;
    \item \textbf{Definir o problema de controle ótimo:}  no arquivo principal, gerados no passo 4 com o problema e definir as condições finais e iniciais para os estados do sistema;
    \item \textbf{Resolver o problema:} chamar o método \lstinline[style=Matlab-editor]{.Solve()}, no arquivo, principal para a resolução do problema.
\end{enumerate}

O código de solução desenvolvido a partir destes passos é composto por quatro aquivos, apresentados na Figura \ref{fig:matlab_files}, três \textit{functions} e um \textit{script}. Os aquivos \textit{function}, \lstinline[style=Matlab-editor]{i_max.m},
\lstinline[style=Matlab-editor]{lagrange_cost.m} e \lstinline[style=Matlab-editor]{mdl_dt1_pista.m} são, respectivamente, 
a restrição de caminho corrente da Equação(\ref{eq:C5_OCP_final}), o custo de Lagrange da Equação (\ref{eq:ObjOCP_final}) e o modelo da dinâmica do veículo da Equação (\ref{eq:modelo_1}) acrescido do modelo de inclinação da pista da Equação (\ref{eq:modeloTheta}).

\begin{figure}[h]
    \centering
    \caption{Arquivos MATLAB  do projeto}
    \includegraphics[]{Metodologia/Figuras/matlab_files.png}
    \label{fig:matlab_files}
    \caption*{\footnotesize{Fonte: Elaborada pelo autor.}}
\end{figure}


Durante a escrita do arquivo \lstinline[style=Matlab-editor]{main.m} uma dificuldade encontrada foi a determinação da variável \lstinline[style=Matlab-editor]{scale}, 
última  variável nos construtores \lstinline[style=Matlab-editor]{falcon.State()}, \lstinline[style=Matlab-editor]{falcon.Control()} e \lstinline[style=Matlab-editor]{falcon.Parameter()}.
Inicialmente os valores definidos foram a ordem de grandeza da cada variável o que gerou matrizes mau condicionadas no NLP e consequente um alto tempo de solução o problema. 
Os valores corretos, conforme sugerido no manual do FALCON.m\cite{manual:Falcon}, dever ser definidos de tal forma que a ordem de grandeza da variável seja um. Por exemplo: uma variávelque
representa a correte elétrica de um circuito em [mA] deve ter o parâmero \lstinline[style=Matlab-editor]{scale} igual a $10^{-3}$. 
A definição dos estados, variável de controle e parâmetros com o parâmetro \lstinline[style=Matlab-editor]{scale} adequado é apresentado no Código \ref{lst:scale}. 

\begin{figure}[h]
    \begin{lstlisting}[
        caption={[Trecho do arquivo main.m]Trecho do arquivo \lstinline[style=Matlab-editor]{main.m} com definição dos estados, variável de controle e parâmetros do OCP proposto}, 
        label={lst:scale},
        style      = Matlab-editor,
        basicstyle = \mlttfamily,
        firstnumber=4]
% vetor de estados
x_vec = [ falcon.State('x',   0,  11000, 1e-4);...
          falcon.State('v',   0,  12.5, 1e-1) ];
% variavel de controle
u_vec = falcon.Control('i', 0,  63, 1);
% tempo final
tf = falcon.Parameter('FinalTime', 1400, 0, 1400, 1e-3);
% raio do cilindro no motor
rm = falcon.Parameter('raioM', 0.026, 0.020, 0.050, 1e2);
    \end{lstlisting}
    \caption*{\footnotesize{Fonte: Elaborado pelo autor.}}
\end{figure}

Além disso, foi verificado que, a biblioteca FALCON.m versão v1.26 não funcionou no MATLAB  R2020a quando o optimizador  IPOPT era utilizado.
Isto ocorreu pois não há garantia de compatibilidade, no Windows, por parte do MATLAB  em sua evolução, a arquivos MEX (interface com programas escritos em C, C++ ou Fortran) gerados em versões 
anteriores e a biblioteca IPOPT é chamada por meio de um arquivo MEX não compatível apos a versão R2019b do MATLAB . Novas versões da FALCON.m
devem possibilitar o uso e versões mais novas do MATLAB  pois os arquivos MEX serão compilados novamente.




\clearpage